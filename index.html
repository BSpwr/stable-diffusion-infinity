<html>
<head>
<title>Stablediffusion Infinity</title>
<meta charset="utf-8">
<link rel="icon" type="image/x-icon" href="./favicon.png">
<link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
<script defer src="https://pyscript.net/alpha/pyscript.js"></script>
<link rel="stylesheet" type="text/css" href="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<script src="./js/fabric.js"></script>
<style>
#container {
  position: relative;
  margin:auto;
  display: block;
}
#container > canvas {
  position: absolute;
  top: 0;
  left: 0;
}
.control {
  display: none;
}
</style>

</head>
<body>
<div>
<button type="button" class="control" id="export">Export</button>
<button type="button" class="control" id="outpaint">Outpaint</button>
<button type="button" class="control" id="undo">Undo</button>
<button type="button" class="control" id="commit">Commit</button>
<button type="button" class="control" id="transfer">Transfer</button>
<button type="button" class="control" id="upload">Upload</button>
<button type="button" class="control" id="draw">Draw</button>
<input type="text" id="mode" value="selection" class="control">
<input type="text" id="setup" value="0" class="control">
<input type="text" id="upload_content" value="0" class="control">
<textarea rows="1" id="selbuffer" name="selbuffer" class="control"></textarea>
<fieldset class="control">
    <div>
      <input type="radio" id="mode0" name="mode" value="0" checked>
      <label for="mode0">SelBox</label>
    </div>
    <div>
      <input type="radio" id="mode1" name="mode" value="1">
      <label for="mode1">Image</label>
    </div>
    <div>
      <input type="radio" id="mode2" name="mode" value="2">
      <label for="mode2">Brush</label>
    </div>
</fieldset>
</div>
<div id = "outer_container">
<div id = "container">
  <canvas id = "canvas0"></canvas>
  <canvas id = "canvas1"></canvas>
  <canvas id = "canvas2"></canvas>
  <canvas id = "canvas3"></canvas>
  <canvas id = "canvas4"></canvas>
  <div id="overlay_container" style="pointer-events: none">
    <canvas id = "overlay_canvas" width="1" height="1"></canvas>
  </div>
</div>
<input type="file" name="file" id="upload_file" accept="image/*" hidden>
<input type="file" name="state" id="upload_state" accept=".json" hidden>
<div style="position: relative;">
<div id="toolbar" style></div>
</div>
</div>
<py-env>
- numpy
- Pillow
- paths:
  - ./canvas.py
</py-env>

<py-script>
from pyodide import to_js, create_proxy
from PIL import Image
import io
import time
import base64
import numpy as np
from js import (
    console,
    document,
    parent,
    devicePixelRatio,
    ImageData,
    Uint8ClampedArray,
    CanvasRenderingContext2D as Context2d,
    requestAnimationFrame,
    window,
    encodeURIComponent,
    w2ui,
    update_eraser,
    update_scale,
    adjust_selection
)


from canvas import InfCanvas



base_lst = [None]
async def draw_canvas() -> None:
    width=1024
    height=600
    canvas=InfCanvas(1024,600)
    update_eraser(canvas.eraser_size,min(canvas.selection_size_h,canvas.selection_size_w))
    document.querySelector("#container").style.height= f"{height}px"
    document.querySelector("#container").style.width = f"{width}px"
    canvas.setup_mouse()
    canvas.clear_background()
    canvas.draw_buffer()
    canvas.draw_selection_box()
    base_lst[0]=canvas

async def draw_canvas_func(event):
    try:
        app=parent.document.querySelector("gradio-app")
        if app.shadowRoot:
            app=app.shadowRoot
        width=app.querySelector("#canvas_width input").value
        height=app.querySelector("#canvas_height input").value
        selection_size=app.querySelector("#selection_size input").value
    except:
        width=1024
        height=768
        selection_size=384
    document.querySelector("#container").style.width = f"{width}px"
    document.querySelector("#container").style.height= f"{height}px"
    canvas=InfCanvas(int(width),int(height),selection_size=int(selection_size))
    canvas.setup_mouse()
    canvas.clear_background()
    canvas.draw_buffer()
    canvas.draw_selection_box()
    base_lst[0]=canvas
  
async def export_func(event):
    base=base_lst[0]
    arr=base.export()
    base.draw_buffer()
    base.canvas[2].clear()
    base64_str = base.numpy_to_base64(arr)
    time_str = time.strftime("%Y%m%d_%H%M%S")
    console.log(f"Canvas saved to outpaint_{time_str}.png")
    link = document.createElement("a")
    link.download = f"outpaint_{time_str}.png"
    link.href = "data:image/png;base64,"+base64_str
    link.click()

img_candidate_lst=[None,0]

async def outpaint_func(event):
    base=base_lst[0]
    #app=parent.document.querySelector("gradio-app")
    #if app.shadowRoot:
    #    app=app.shadowRoot
    #base64_str_raw=app.querySelector("#output textarea").value
    #base64_str_lst=base64_str_raw.split(",")
    #arr=base.base64_to_numpy(base64_str_lst[0])
    rgb_color=(100,120,140)
    WIDTH_LIMIT=base.selection_size_w
    HEIGHT_LIMIT=base.selection_size_h
    x = np.ones((HEIGHT_LIMIT, WIDTH_LIMIT, 4)) 
    x[:, :, 0:3] = rgb_color
    y = np.ones((HEIGHT_LIMIT, WIDTH_LIMIT, 4))
    y[:,:,0:3] = [min(40 + color, 255) for color in rgb_color]
    c = np.linspace(0, 1, WIDTH_LIMIT)[None,:, None]
    gradient = x + (y - x) * c
    gradient[:,:,-1]=255
    arr=gradient.astype(np.uint8)
    base.fill_selection(arr)
    base.draw_selection_box()

async def undo_func(event):
    base=base_lst[0]
    img_candidate_lst[0]=None
    if base.sel_dirty:
        base.canvas[2].clear()
        base.sel_buffer = base.sel_buffer_bak.copy()
        base.sel_dirty = False

async def commit_func(event):
    base=base_lst[0]
    img_candidate_lst[0]=None
    if base.sel_dirty:
        base.write_selection_to_buffer()

async def transfer_func(event):
    base=base_lst[0]
    base.read_selection_from_buffer()
    sel_buffer=base.sel_buffer
    sel_buffer_str=base.numpy_to_base64(sel_buffer)
    app=parent.document.querySelector("gradio-app")
    if app.shadowRoot:
        app=app.shadowRoot
    app.shadowRoot.querySelector("#input textarea").value=sel_buffer_str
    app.shadowRoot.querySelector("#proceed").click()

async def upload_func(event):
    base=base_lst[0]
    # base64_str=event.data[1]
    base64_str=document.querySelector("#upload_content").value
    base64_str=base64_str.split(",")[-1]
    # base64_str=parent.document.querySelector("gradio-app").shadowRoot.querySelector("#upload textarea").value
    arr=base.base64_to_numpy(base64_str)
    h,w,c=base.buffer.shape
    base.sync_to_buffer()
    base.buffer_dirty=True
    mask=arr[:,:,3:4].repeat(4,axis=2)
    base.buffer[mask>0]=0
    # in case mismatch
    base.buffer[0:h,0:w,:]+=arr
    #base.buffer[yo:yo+h,xo:xo+w,0:3]=arr[:,:,0:3]
    #base.buffer[yo:yo+h,xo:xo+w,-1]=arr[:,:,-1]
    base.draw_buffer()

  

document.querySelector("#export").addEventListener("click",create_proxy(export_func))
document.querySelector("#undo").addEventListener("click",create_proxy(undo_func))
document.querySelector("#commit").addEventListener("click",create_proxy(commit_func))
document.querySelector("#outpaint").addEventListener("click",create_proxy(outpaint_func))
document.querySelector("#upload").addEventListener("click",create_proxy(upload_func))

document.querySelector("#transfer").addEventListener("click",create_proxy(transfer_func))
document.querySelector("#draw").addEventListener("click",create_proxy(draw_canvas_func))

async def setup_func():
    document.querySelector("#setup").value="1"

async def reset_func(event):
    base=base_lst[0]
    base.reset()
    
async def load_func(event):
    base=base_lst[0]
    base.load(event.data[1])

async def save_func(event):
    base=base_lst[0]
    json_str=base.save()
    time_str = time.strftime("%Y%m%d_%H%M%S")
    link = document.createElement("a")
    link.download = f"sdinf_state_{time_str}.json"
    link.href = "data:text/json;charset=utf-8,"+encodeURIComponent(json_str)
    link.click()

async def prev_result_func(event):
    base=base_lst[0]
    base.reset()

async def next_result_func(event):
    base=base_lst[0]
    base.reset()

async def zoom_in_func(event):
    base=base_lst[0]
    scale=base.scale
    if scale>=0.2:
        scale-=0.1
        if len(event.data)>2:
            base.update_scale(scale,int(event.data[2]),int(event.data[3]))
        else:
            base.update_scale(scale)
        scale=base.scale
        update_scale(round(100/scale))

async def zoom_out_func(event):
    base=base_lst[0]
    scale=base.scale
    if scale<10:
        scale+=0.1
        console.log(len(event.data))
        if len(event.data)>2:
            base.update_scale(scale,int(event.data[2]),int(event.data[3]))
        else:
            base.update_scale(scale)
        scale=base.scale
        update_scale(round(100/scale))

async def sync_func(event):
    base=base_lst[0]
    base.sync_to_buffer()

async def eraser_size_func(event):
    base=base_lst[0]
    eraser_size=min(int(event.data[1]),min(base.selection_size_h,base.selection_size_w))
    eraser_size=max(8,eraser_size)
    base.eraser_size=eraser_size

async def resize_selection_func(event):
    base=base_lst[0]
    cursor=base.cursor
    if len(event.data)>3:
        console.log(event.data)
        base.cursor[0]=int(event.data[1])
        base.cursor[1]=int(event.data[2])
        base.selection_size_w=int(event.data[3])
        base.selection_size_h=int(event.data[4])
        base.refine_selection()
        base.draw_selection_box()
    elif len(event.data)>2:
        base.draw_selection_box()
    else:
        base.canvas[-1].clear()
        adjust_selection(cursor[0],cursor[1],base.selection_size_w,base.selection_size_h)

async def message_func(event):
    if event.data[0]=="click":
        if event.data[1]=="clear":
            await reset_func(event)
        elif event.data[1]=="save":
            await save_func(event)
        elif event.data[1]=="export":
            await export_func(event)
        elif event.data[1]=="accept":
            await commit_func(event)
        elif event.data[1]=="cancel":
            await undo_func(event)
        elif event.data[1]=="prev":
            await prev_result_func(event)
        elif event.data[1]=="next":
            await next_result_func(event)
        elif event.data[1]=="zoom_in":
            await zoom_in_func(event)
        elif event.data[1]=="zoom_out":
            await zoom_out_func(event)
    elif event.data[0]=="sync":
        await sync_func(event)
    elif event.data[0]=="load":
        await load_func(event)
    elif event.data[0]=="upload":
        await upload_func(event)
    elif event.data[0]=="outpaint":
        await outpaint_func(event)
    elif event.data[0]=="mode":
        if event.data[1]!="selection":
            await sync_func(event)
        document.querySelector("#mode").value=event.data[1]
    elif event.data[0]=="transfer":
        await transfer_func(event)
    elif event.data[0]=="setup":
        await draw_canvas_func(event)
    elif event.data[0]=="eraser_size":
        await eraser_size_func(event)
    elif event.data[0]=="resize_selection":
        await resize_selection_func(event)
    
window.addEventListener("message",create_proxy(message_func))

import asyncio

_ = await asyncio.gather(
  setup_func(),draw_canvas()
)
</py-script>

<script type="module">
// import { w2ui,w2toolbar,w2field, query, w2alert} from "https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.es6.min.js"
import { w2ui,w2toolbar,w2field,query,w2alert, w2utils,w2confirm} from "./w2ui.es6.min.js"

// https://stackoverflow.com/questions/36280818/how-to-convert-file-to-base64-in-javascript
function getBase64(file) {
   var reader = new FileReader();
   reader.readAsDataURL(file);
   reader.onload = function () {
    add_image(reader.result);
    //  console.log(reader.result);
   };
   reader.onerror = function (error) {
     console.log("Error: ", error);
   };
}

function getText(file) {
   var reader = new FileReader();
   reader.readAsText(file);
   reader.onload = function () {
    window.postMessage(["load",reader.result],"*")
    //  console.log(reader.result);
   };
   reader.onerror = function (error) {
     console.log("Error: ", error);
   };
}

document.querySelector("#upload_file").addEventListener("change", (event)=>{
    console.log(event);
    let file = document.querySelector("#upload_file").files[0];
    getBase64(file);
})

document.querySelector("#upload_state").addEventListener("change", (event)=>{
    console.log(event);
    let file = document.querySelector("#upload_state").files[0];
    getText(file);
})

var button_lst=["clear", "load", "save", "export", "upload", "selection", "canvas", "eraser", "outpaint", "accept", "cancel", "retry", "prev", "current", "next", "eraser_size_btn", "eraser_size", "resize_selection", "scale", "zoom_in", "zoom_out", "help"];
var upload_button_lst=['clear', 'load', 'save', "upload", 'export', 'outpaint', 'resize_selection', 'help'];
var resize_button_lst=['clear', 'load', 'save', "upload", 'export', "selection", "canvas", "eraser", 'outpaint', 'resize_selection',"zoom_in", "zoom_out", 'help'];
var outpaint_button_lst=['clear', 'load', 'save', "canvas", "eraser", "upload", 'export', 'resize_selection', "zoom_in", "zoom_out",'help'];
var outpaint_result_lst=["accept", "cancel", "retry", "prev", "current", "next"];
var toolbar=new w2toolbar({
    box: "#toolbar",
    name: "toolbar",
    tooltip: "top",
    items: [
        { type: "button", id: "clear", text: "Reset", icon: "fa-solid fa-rectangle-xmark" },
        { type: "break" },
        { type: "button", id: "load", tooltip: "Load Canvas", icon: "fa-solid fa-file-import" },
        { type: "button", id: "save", tooltip: "Save Canvas", icon: "fa-solid fa-file-export" },
        { type: "button", id: "export", tooltip: "Export Image", icon: "fa-solid fa-floppy-disk" },
        { type: "break" },
        { type: "button", id: "upload", text: "Upload Image", icon: "fa-solid fa-upload" },
        { type: "break" },
        { type: "radio", id: "selection", group: "1", tooltip: "Selection", icon: "fa-solid fa-arrows-up-down-left-right", checked: true },
        { type: "radio", id: "canvas", group: "1", tooltip: "Canvas", icon: "fa-solid fa-image" },
        { type: "radio", id: "eraser", group: "1", tooltip: "Eraser", icon: "fa-solid fa-eraser" },
        { type: "break" },
        { type: "button", id: "outpaint", text: "Outpaint", icon: "fa-solid fa-brush" },
        { type: "break" },
        { type: "button", id: "accept", text: "Accept", icon: "fa-solid fa-check", hidden: true, disable:true,},
        { type: "button", id: "cancel", text: "Cancel", icon: "fa-solid fa-ban", hidden: true, disable:true,},
        { type: "button", id: "retry", text: "Retry", icon: "fa-solid fa-rotate", hidden: true, disable:true,},
        { type: "button", id: "prev", tooltip: "Prev Result", icon: "fa-solid fa-caret-left", hidden: true, disable:true,},
        { type: "html", id: "current", hidden: true, disable:true,
            async onRefresh(event) {
                await event.complete
                let fragment = query.html(`
                <div class="w2ui-tb-text">
                <div class="w2ui-tb-count">
                    <span>${this.sel_value ?? "1/1"}</span>
                </div> </div>`)
                query(this.box).find("#tb_toolbar_item_current").append(fragment)
            }
        },
        { type: "button", id: "next", tooltip: "Next Result", icon: "fa-solid fa-caret-right", hidden: true,disable:true,},
        { type: "button", id: "add_image", text: "Add Image", icon: "fa-solid fa-file-circle-plus", hidden: true,disable:true,},
        { type: "button", id: "delete_image", text: "Delete Image", icon: "fa-solid fa-trash-can", hidden: true,disable:true,},
        { type: "button", id: "confirm", text: "Confirm", icon: "fa-solid fa-check", hidden: true,disable:true,},
        { type: "button", id: "cancel_overlay", text: "Cancel", icon: "fa-solid fa-ban", hidden: true,disable:true,},
        { type: "break" },
        { type: "spacer" },
        { type: "break" },
        { type: "button", id: "eraser_size_btn", tooltip: "Eraser Size", text:"Size", icon: "fa-solid fa-eraser", hidden: true, count: 32},
        { type: "html", id: "eraser_size", hidden: true,
            async onRefresh(event) {
                await event.complete
                // let fragment = query.html(`
                //     <input type="number" size="${this.eraser_size ? this.eraser_size.length:"2"}" style="margin: 0px 3px; padding: 4px;" min="8" max="${this.eraser_max ?? "256"}" value="${this.eraser_size ?? "32"}">
                //     <input type="range" style="margin: 0px 3px; padding: 4px;" min="8" max="${this.eraser_max ?? "256"}" value="${this.eraser_size ?? "32"}">`)
                let fragment = query.html(`
                    <input type="range" style="margin: 0px 3px; padding: 4px;" min="8" max="${this.eraser_max ?? "256"}" value="${this.eraser_size ?? "32"}">
                    `)
                fragment.filter("input").on("change", event => {
                    this.eraser_size = event.target.value;
                    window.overlay.freeDrawingBrush.width=this.eraser_size;
                    this.setCount("eraser_size_btn", event.target.value);
                    window.postMessage(["eraser_size", event.target.value],"*")
                    this.refresh();
                })
                query(this.box).find("#tb_toolbar_item_eraser_size").append(fragment)
            }
        },
        // { type: "button", id: "resize_eraser", tooltip: "Resize Eraser", icon: "fa-solid fa-sliders" },
        { type: "button", id: "resize_selection", tooltip: "Resize Selection", icon: "fa-solid fa-expand" },
        { type: "break" },
        { type: "html", id: "scale",
            async onRefresh(event) {
                await event.complete
                let fragment = query.html(`
                <div class="">
                <div style="padding: 4px; border: 1px solid silver">
                    <span>${this.scale_value ?? "100%"}</span>
                </div></div>`)
                query(this.box).find("#tb_toolbar_item_scale").append(fragment)
            }
        },
        { type: "button", id: "zoom_in", tooltip: "Zoom In", icon: "fa-solid fa-magnifying-glass-plus" },
        { type: "button", id: "zoom_out", tooltip: "Zoom Out", icon: "fa-solid fa-magnifying-glass-minus" },
        { type: "break" },
        { type: "button", id: "help", tooltip: "Help", icon: "fa-solid fa-circle-info" }
    ],
    onClick(event) {
        switch(event.target){
            case "upload":
                this.upload_mode=true
                document.querySelector("#overlay_container").style.pointerEvents="auto";
                this.click("canvas");
                this.click("selection");
                this.show("confirm","cancel_overlay","add_image","delete_image");
                this.enable("confirm","cancel_overlay","add_image","delete_image");
                this.disable(...upload_button_lst);
                query("#upload_file").click();
                break;
            case "resize_selection":
                this.resize_mode=true;
                this.disable(...resize_button_lst);
                this.enable("confirm","cancel_overlay");
                this.show("confirm","cancel_overlay");
                window.postMessage(["resize_selection",""],"*");
                document.querySelector("#overlay_container").style.pointerEvents="auto";
                break;
            case "confirm":
                if(this.upload_mode)
                {
                    export_image();
                }
                else
                {
                    let sel_box=this.selection_box;
                    window.postMessage(["resize_selection",sel_box.x,sel_box.y,sel_box.width,sel_box.height],"*");
                }
            case "cancel_overlay":
                end_overlay();
                this.hide("confirm","cancel_overlay","add_image","delete_image");
                if(this.upload_mode){
                    this.enable(...upload_button_lst);
                }
                else
                {
                    this.enable(...resize_button_lst);
                    window.postMessage(["resize_selection","",""],"*");
                }
                this.disable("confirm","cancel_overlay","add_image","delete_image");
                this.upload_mode=false;
                this.resize_mode=false;
                this.click("selection");
                break;
            case "add_image":
                query("#upload_file").click();
                break;
            case "delete_image":
                let active_obj = window.overlay.getActiveObject();
                if(active_obj)
                {
                    window.overlay.remove(active_obj);
                    window.overlay.renderAll();
                }
                else
                {
                    w2utils.notify("You need to select an image first",{error:true,timeout:2000,where:query("#container")})
                }
                break;
            case "load":
                query("#upload_state").click()
                break;
            case "outpaint":
                this.disable(...outpaint_button_lst);
                this.show(...outpaint_result_lst);
                this.enable(...outpaint_result_lst);
                if(this.outpaint_tip)
                {
                    this.outpaint_tip=false;
                    w2utils.notify("The canvas stays locked until you accept/cancel current outpainting",{timeout:10000,where:query("#container")})
                }
                document.querySelector("#container").style.pointerEvents="none";
            case "retry":
                window.postMessage(["outpaint",""],"*")
                break;
            case "accept":
            case "cancel":
                this.hide(...outpaint_result_lst);
                this.disable(...outpaint_result_lst);
                this.enable(...outpaint_button_lst);
                document.querySelector("#container").style.pointerEvents="auto";
                window.postMessage(["click", event.target],"*");
                break;
            case "eraser":
            case "selection":
            case "canvas":
                if(event.target=="eraser")
                {
                    this.show("eraser_size","eraser_size_btn");
                    window.overlay.freeDrawingBrush.width=this.eraser_size;
                    window.overlay.isDrawingMode = true;
                }
                else
                {
                    this.hide("eraser_size","eraser_size_btn");
                    window.overlay.isDrawingMode = false;
                }
                if(this.upload_mode)
                {
                    if(event.target=="canvas")
                    {
                        window.postMessage(["mode", event.target],"*")
                        document.querySelector("#overlay_container").style.pointerEvents="none";
                        document.querySelector("#overlay_container").style.opacity = 0.5;
                    }
                    else
                    {
                        document.querySelector("#overlay_container").style.pointerEvents="auto";
                        document.querySelector("#overlay_container").style.opacity = 1.0;
                    }
                }
                else
                {
                    window.postMessage(["mode", event.target],"*")
                }
                break;
            case "help":
                w2alert("stablediffusion-infinity: https://github.com/lkwq007/stablediffusion-infinity");
                break;
            case "clear":
                w2confirm("Reset canvas?").yes(() => {
                    window.postMessage(["click", event.target],"*");
                }).no(() => {})
                break;
            default:
                // clear, save, export, outpaint, retry
                // break, save, export, accept, retry, outpaint
                window.postMessage(["click", event.target],"*")
        }
        console.log("Target: "+ event.target, event)
    }
})
window.w2ui=w2ui;
w2ui.toolbar.outpaint_tip=true;
window.update_count=function(cur,total){
  w2ui.toolbar.sel_value=`${cur}/${total}`;
  w2ui.toolbar.refresh();
}
window.update_eraser=function(val,max_val){
  w2ui.toolbar.eraser_size=`${val}`;
  w2ui.toolbar.eraser_max=`${max_val}`;
  w2ui.toolbar.setCount("eraser_size_btn", `${val}`);
  w2ui.toolbar.refresh();
}
window.update_scale=function(val){
  w2ui.toolbar.scale_value=`${val}%`;
  w2ui.toolbar.refresh();
}
</script>
<script>
function onObjectScaled(e)
{
    let object = e.target;
    if(object.isType("rect"))
    {
        let width=object.getScaledWidth();
        let height=object.getScaledHeight();
        object.scale(1);
        width=Math.max(Math.min(width,window.overlay.width-object.left),256);
        height=Math.max(Math.min(height,window.overlay.height-object.top),256);
        let l=Math.max(Math.min(object.left,window.overlay.width-width-object.strokeWidth),0);
        let t=Math.max(Math.min(object.top,window.overlay.height-height-object.strokeWidth),0);
        object.set({ width: width, height: height, left:l,top:t})
        window.w2ui.toolbar.selection_box={width: width, height: height, x:object.left, y:object.top};
    }
}
function onObjectMoved(e)
{
    let object = e.target;
    if(object.isType("rect"))
    {   
        let l=Math.max(Math.min(object.left,window.overlay.width-object.width-object.strokeWidth),0);
        let t=Math.max(Math.min(object.top,window.overlay.height-object.height-object.strokeWidth),0);
        object.set({left:l,top:t});
        window.w2ui.toolbar.selection_box={width: object.width, height: object.height, x:object.left, y:object.top};
    }
}
window.setup_overlay=function(width,height)
{
    if(window.overlay)
    {
        window.overlay.setDimensions({width:width,height:height});
    }
    else
    {
        canvas=new fabric.Canvas("overlay_canvas");
        canvas.setDimensions({width:width,height:height});
        canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
        canvas.on("object:scaling", onObjectScaled);
        canvas.on("object:moving", onObjectMoved);
        window.overlay=canvas;
    }
    document.querySelector("#overlay_container").style.pointerEvents="none";
}
window.update_overlay=function(width,height)
{
    window.overlay.setDimensions({width:width,height:height},{backstoreOnly:true});
    // document.querySelector("#overlay_container").style.pointerEvents="none";
}
window.adjust_selection=function(x,y,width,height)
{
    var rect = new fabric.Rect({
        left: x,
        top: y,
        fill: "rgba(0,0,0,0)",
        strokeWidth: 3, 
        stroke: "rgba(0,0,0,0.7)",
        cornerColor: "red",
        cornerStrokeColor: "red",
        borderColor: "rgba(255, 0, 0, 1.0)",
        width: width,
        height: height,
        lockRotation: true,
    });
    rect.setControlsVisibility({ mtr: false });
    window.overlay.add(rect);
    window.overlay.setActiveObject(window.overlay.item(0));
}
function add_image(url)
{
    fabric.Image.fromURL(url,function(img){
        window.overlay.add(img);
        window.overlay.setActiveObject(img);
    },{left:100,top:100});
}
function export_image()
{
    data=window.overlay.toDataURL();
    document.querySelector("#upload_content").value=data;
    window.postMessage(["upload",""],"*");
    end_overlay();
}
function end_overlay()
{
    window.overlay.clear();
    document.querySelector("#overlay_container").style.opacity = 1.0;
    document.querySelector("#overlay_container").style.pointerEvents="none";
}
</script>
</body>
</html>
